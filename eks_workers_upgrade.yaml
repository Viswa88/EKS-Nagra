#####################################################################
###                Get existing Worker Instances                  ###
#####################################################################
---
- hosts: localhost
  gather_facts: false
  tasks:
    - name: Get EKS Worker Instances
      ec2_instance_info:
        aws_access_key: "{{ aws_access_key }}"
        aws_secret_key: "{{ aws_secret_key }}"
        region: "{{vpc['region']}}"
        filters:
          "instance-state-name": "running"
          "tag:Name": "{{environment_name}}-kubernetes-eks-node"
          "tag:environment": "{{environment_name}}"
      register: ec2_info

    - name: displaying output
      debug: msg="{{item.instance_id}}"
      with_items: "{{ec2_info.instances}}"

#####################################################################
###                       Get Kubernetes Nodes                    ###
#####################################################################

- hosts: gateways
  gather_facts: false
  tasks:
    - name: "Kubernetes nodes"
      command: "kubectl get no -o=custom-columns=NAME:.metadata.name --no-headers"
      register: nodes_info

    - debug: var=nodes_info.stdout_lines

#####################################################################
###                     Gather ASG details                        ###
#####################################################################

- hosts: localhost
  gather_facts: false
  tasks:
   - name: "Gather ASG info in VPC"
     ec2_asg_info:
       name: "{{ environment_name }}-kubernetes-eks-node-asg"
       aws_access_key: "{{ aws_access_key }}"
       aws_secret_key: "{{ aws_secret_key }}"
       region: "{{vpc['region']}}"
       tags:
         vpc_name: "{{ vpc_name }}"
     register: asgs

- hosts: localhost
  gather_facts: false
  tasks:
   - name: "Get ASG actual desired count"
     set_fact:
       desired_count: "{{ k8s_worker_max_count }}"
       min_count: "{{ k8s_worker_count }}"
       max_count: "{{ k8s_worker_max_count }}"

#####################################################################
###                       Increase ASG                            ###
#####################################################################
- hosts: localhost
  gather_facts: false
  tasks:
    - name: "Increase ASG desired capacity"
      set_fact:
        desired_count_updated: "{{ desired_count|int * 2|int }}"
        max_count_updated: "{{ max_count|int * 2|int }}"

- hosts: localhost
  gather_facts: false
  tasks:
    - name: start ASG instances
      ec2_asg:
         aws_access_key: "{{ aws_access_key }}"
         aws_secret_key: "{{ aws_secret_key }}"
         region: "{{vpc['region']}}"
         name: "{{ environment_name }}-kubernetes-eks-node-asg"
         min_size: "{{ min_count }}"
         max_size: "{{ max_count_updated }}"
         desired_capacity: "{{ desired_count_updated }}"

- hosts: localhost
  gather_facts: false
  tasks:
    - name: Wait 120 seconds for new instances to become reachable/usable
      wait_for_connection:
      sleep: 120
 
#####################################################################
###                      Drain Kubernetes nodes                   ###
#####################################################################

- hosts: gateways
  gather_facts: false
  tasks:
   - name: Kubernetes drain nodes
     command: "kubectl drain {{ item }} --ignore-daemonsets --grace-period=60 --delete-local-data"
     loop: "{{ nodes_info.stdout_lines }}"

#####################################################################
###                  Terminate old ec2-instances                  ###
#####################################################################

- hosts: localhost
  gather_facts: false
  tasks:
     - name: Terminate old version eks instances
       ec2:
         aws_access_key: "{{ aws_access_key }}"
         aws_secret_key: "{{ aws_secret_key }}"
         region: "{{vpc['region']}}"
         state: 'absent'
         instance_ids: "{{item.instance_id}}"
       with_items: "{{ec2_info.instances}}"

#####################################################################
###                       Decrease ASG value                      ###
#####################################################################

- hosts: localhost
  gather_facts: false
  tasks:
    - name: Normalize asg desired count
      ec2_asg:
         aws_access_key: "{{ aws_access_key }}"
         aws_secret_key: "{{ aws_secret_key }}"
         region: "{{vpc['region']}}"
         name: "{{ environment_name }}-kubernetes-eks-node-asg"
         min_size: "{{ k8s_worker_count }}"
         max_size: "{{ k8s_worker_count }}"
         desired_capacity: "{{ asg_info['results'][0]['desired_capacity'] | default(k8s_worker_count,true) }}"

#####################################################################
###                Delete PDB from services                       ###
#####################################################################

- hosts: gateways
  gather_facts: false
  tasks:
    - name: Remove PDB for OPF3 services
      include_role:
        name: services
      vars:
        action: "pdb_remove"
      loop: "{{services | dict2items }}"
      when: (services_to_deploy is defined and current_service.key in services_to_deploy) or services_to_deploy is not defined
      loop_control:
        loop_var: current_service